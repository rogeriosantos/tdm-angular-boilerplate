import { Injectable, inject } from '@angular/core';
import { HttpClient } from '@angular/common/http';
import { Observable, of } from 'rxjs';
import { catchError, map, tap } from 'rxjs/operators';
import { SystemInfo } from '../models/system-info.model';
import { environment } from '../../environments/environment';

@Injectable({
  providedIn: 'root',
})
export class SystemInfoService {
  private http = inject(HttpClient);
  private readonly apiUrl = environment.apiUrl || 'https://pw-gkyr1t3/202501HF01local';

  getSystemInfo(): Observable<SystemInfo> {
    return this.http.get<SystemInfo>(`${this.apiUrl}/api/System/SystemInfo`).pipe(
      tap((systemInfo) => {
        console.log('=== SystemInfo API Response ===');
        console.log('Full Response:', systemInfo);
        console.log('User ID:', systemInfo.userId);
        console.log('Language:', systemInfo.language);
        console.log('Data Language:', systemInfo.dataLanguage);
        console.log('Server URL:', systemInfo.serverUrl);
        console.log('================================');
      }),
      catchError((error) => {
        console.error('❌ Failed to fetch system info:', error);
        console.error('❌ SystemInfo API is not working - NO MOCK DATA PROVIDED');
        
        // Don't provide fallback data - let the error propagate
        throw error;
      })
    );
  }

  getUserLanguageSettings(): Observable<{ uiLanguage: string; dataLanguage: string }> {
    return this.getSystemInfo().pipe(
      map((systemInfo) => {
        const uiLanguage = this.convertToSupportedLanguage(systemInfo.language);
        const dataLanguage = this.convertToSupportedLanguage(systemInfo.dataLanguage);

        console.log('=== Language Conversion ===');
        console.log('Original UI Language:', systemInfo.language, '-> Converted:', uiLanguage);
        console.log(
          'Original Data Language:',
          systemInfo.dataLanguage,
          '-> Converted:',
          dataLanguage
        );
        console.log('===========================');

        return {
          uiLanguage,
          dataLanguage,
        };
      })
    );
  }

  private convertToSupportedLanguage(language: string): string {
    // Convert full locale to supported language code
    if (language.startsWith('en')) return 'en';
    if (language.startsWith('de')) return 'de';
    // Add more languages as needed
    console.warn(`⚠️ Unsupported language: ${language}, falling back to 'en'`);
    return 'en'; // fallback to English
  }
}
